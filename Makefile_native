# Makefile for the deep learning server example
#
# AUTHORS
#
# The Veracruz Development Team.
#
# COPYRIGHT AND LICENSING
#
# See the `LICENSE_MIT.markdown` file in the Veracruz deep learning server 
# example repository root directory for copyright and licensing information.


##########################################################
EXEC=detector
DARKNET_PATH = darknet
OPENH264_LIB_PATH = openh264
OPENH264DEC_LIB_PATH = openh264-dec
VPATH=./$(DARKNET_PATH)
OBJ=o

############
ifeq ($(shell uname), Darwin)
	OS=macos
endif
ifeq ($(shell uname), Linux)
	OS=linux
endif

############
CFLAGS=-Wall -Wno-unused-result -Wno-unknown-pragmas -Wfatal-errors -Wno-write-strings -fPIC -march=native
OPTS=-O3
#OPTS=-O0 -g

CFLAGS+=$(OPTS)

LDFLAGS= -lm

############
# compare.c is excluded from the source because it fails to compile
DARKNET_SRC = gemm.c utils.c cuda.c deconvolutional_layer.c convolutional_layer.c list.c image.c activations.c im2col.c col2im.c blas.c crop_layer.c dropout_layer.c maxpool_layer.c softmax_layer.c data.c matrix.c network.c connected_layer.c cost_layer.c parser.c option_list.c detection_layer.c route_layer.c upsample_layer.c box.c normalization_layer.c avgpool_layer.c layer.c local_layer.c shortcut_layer.c logistic_layer.c activation_layer.c rnn_layer.c gru_layer.c crnn_layer.c demo.c batchnorm_layer.c region_layer.c reorg_layer.c tree.c  lstm_layer.c l2norm_layer.c yolo_layer.c iseg_layer.c
DARKNET_SRCS = $(addprefix $(DARKNET_PATH)/, $(DARKNET_SRC))
DARKNET_OBJS = $(DARKNET_SRCS:%.c=%.$(OBJ))

PROTO_SRC = helloworld.proto
PROTO_OBJS = $(wildcard include/$(basename $(PROTO_SRC))*)
PROTOBUF_ABSL_DEPS = absl_absl_check absl_absl_log absl_algorithm absl_base absl_bind_front absl_bits absl_btree absl_cleanup absl_cord absl_core_headers absl_debugging absl_die_if_null absl_dynamic_annotations absl_flags absl_flat_hash_map absl_flat_hash_set absl_function_ref absl_hash absl_layout absl_log_initialize absl_log_severity absl_memory absl_node_hash_map absl_node_hash_set absl_optional absl_span absl_status absl_statusor absl_strings absl_synchronization absl_time absl_type_traits absl_utility absl_variant
PROTOBUF_UTF8_RANGE_LINK_LIBS = -lutf8_validity

LDFLAGS += -L/usr/local/lib `pkg-config --libs --static protobuf grpc++ absl_flags absl_flags_parse $(PROTOBUF_ABSL_DEPS)` \
		   -L/work/opt/lib \
           $(PROTOBUF_UTF8_RANGE_LINK_LIBS) \
           -pthread \
           -lgrpc++_reflection \
           -ldl \

export PKG_CONFIG_PATH:=$(GRPC_PATH)/share/pkgconfig:$(GRPC_PATH)/lib/pkgconfig
export LDFLAGS:=$(LDFLAGS)

MAIN_SRCS = $(wildcard src/*.cpp)

##########################################################
.PHONY: proto yolo_detection clean 
.DEFAULT_GOAL := all

all: $(EXEC)


##########################################################
$(EXEC): $(DARKNET_OBJS) $(MAIN_SRCS) libopenh264_native.a libopenh264dec_native.a proto
	$(CXX) $(CFLAGS) $(DARKNET_OBJS) $(MAIN_SRCS) $(PROTO_OBJS) -o $@ $(LDFLAGS) -Iinclude -I$(DARKNET_PATH) -I $(OPENH264_LIB_PATH)/codec/api/svc -I $(OPENH264DEC_LIB_PATH)/inc -I $(GRPC_PATH)/include -L $(OPENH264DEC_LIB_PATH) -lopenh264dec_native -L $(OPENH264_LIB_PATH) -lopenh264_native -static
	#$(CXX) $(CFLAGS) $(DARKNET_OBJS) $(MAIN_SRCS) -o $@ $(LDFLAGS) -Iinclude -I$(DARKNET_PATH) -I $(OPENH264_LIB_PATH)/codec/api/svc -I $(OPENH264DEC_LIB_PATH)/inc -I $(GRPC_PATH)/include -I  -L $(OPENH264DEC_LIB_PATH) -lopenh264dec_native -L $(OPENH264_LIB_PATH) -lopenh264_native -pthread

$(DARKNET_PATH)/%.$(OBJ): %.c
	$(CC) $(CFLAGS) -I$(DARKNET_PATH) -Iinclude -c $< -o $@

libopenh264_native.a:
	make -f Makefile_native -C $(OPENH264_LIB_PATH) libopenh264_native.a
	#make -f Makefile_native -C $(OPENH264_LIB_PATH) CFLAGS="-DENABLE_THREADS -DENABLE_SEMAPHORES" libopenh264_native.a

libopenh264dec_native.a:
	make -f Makefile_native -C $(OPENH264DEC_LIB_PATH)

proto:
	$(GRPC_PATH)/bin/protoc --grpc_out include --cpp_out include -I proto --plugin=protoc-gen-grpc="/work/opt/bin/grpc_cpp_plugin" proto/$(PROTO_SRC)

##########################################################
# Generate alphabet for box annotation
generate_alphabet:
	cd labels && python make_labels.py

clean:
	rm -rf $(DARKNET_OBJS) $(EXEC) $(PROTO_OBJS)